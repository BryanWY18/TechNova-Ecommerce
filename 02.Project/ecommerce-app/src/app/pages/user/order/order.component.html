@defer (on viewport) {
  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Mis Órdenes</h1>
        <p class="mt-2 text-sm text-gray-600">Historial de tus compras y estado de envío</p>
      </div>

      <!-- Orders List -->
      <div *ngIf="orderData$ | async as orders; else loading">
        <!-- Empty State -->
        <div *ngIf="orders.length === 0" class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No tienes órdenes</h3>
          <p class="mt-1 text-sm text-gray-500">Comienza a comprar para ver tus órdenes aquí</p>
          <div class="mt-6">
            <button routerLink="/products" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
              Explorar Productos
            </button>
          </div>
        </div>

        <div *ngIf="orders.length > 0" class="space-y-6">
          <div *ngFor="let order of orders" class="bg-white shadow rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
            <!-- Order Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <p class="text-sm text-gray-600">Orden #{{ order._id.slice(-8).toUpperCase() }}</p>
                </div>
                <div class="flex items-center gap-4">
                  <!-- Status -->
                  <span [ngClass]="{
                    'bg-yellow-100 text-yellow-800': order.status === 'pending',
                    'bg-blue-100 text-blue-800': order.status === 'processing',
                    'bg-purple-100 text-purple-800': order.status === 'shipped',
                    'bg-green-100 text-green-800': order.status === 'delivered',
                    'bg-red-100 text-red-800': order.status === 'cancelled'
                  }" class="px-3 py-1 rounded-full text-xs font-medium capitalize">
                    {{ order.status }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Order Body -->
            <div class="px-6 py-4">
              <!-- Products -->
              <div class="space-y-4 mb-4">
                <div *ngFor="let item of order.products" class="flex items-center gap-4">
                  <img 
                    [src]="item.productId.imagesUrl?.[0] || 'assets/placeholder.jpg'" 
                    [alt]="item.productId.name"
                    class="w-16 h-16 object-cover rounded-md border border-gray-200"
                  />
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">{{ item.productId.name }}</p>
                    <p class="text-sm text-gray-500">Cantidad: {{ item.quantity }}</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-900">${{ item.price * item.quantity | number:'1.2-2' }}</p>
                    <p class="text-xs text-gray-500">${{ item.price | number:'1.2-2' }} c/u</p>
                  </div>
                </div>
              </div>

              <!-- Shipping -->
              <div class="border-t border-gray-200 pt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h4 class="text-sm font-medium text-gray-900 mb-2">Dirección de Envío</h4>
                  <p class="text-sm text-gray-600">{{ order.shippingAddress.address }}</p>
                  <p class="text-sm text-gray-600">{{ order.shippingAddress.city }}, {{ order.shippingAddress.state }}</p>
                  <p class="text-sm text-gray-600">{{ order.shippingAddress.postalCode }}</p>
                </div>
                <div>
                  <h4 class="text-sm font-medium text-gray-900 mb-2">Método de Pago</h4>
                  <p class="text-sm text-gray-600 capitalize">{{ order.paymentMethod.type }}</p>
                  <p class="text-sm text-gray-600">**** {{ order.paymentMethod.cardNumber?.slice(-4) }}</p>
                </div>
              </div>

              <!-- Total -->
              <div class="border-t border-gray-200 mt-4 pt-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Subtotal</span>
                  <span class="text-gray-900">${{ (order.totalPrice - order.shippingCost) | number:'1.2-2' }}</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Envío</span>
                  <span class="text-gray-900">${{ order.shippingCost | number:'1.2-2' }}</span>
                </div>
                <div class="flex justify-between text-base font-semibold border-t pt-2">
                  <span class="text-gray-900">Total</span>
                  <span class="text-gray-900">${{ order.totalPrice | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
              <div class="flex flex-wrap gap-3">
                <button 
                  *ngIf="order.status === 'delivered'"
                  class="inline-flex items-center px-4 py-2 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50"
                >
                  Comprar de Nuevo
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <ng-template #loading>
        <div class="flex justify-center items-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      </ng-template>
    </div>
  </div>
} @loading (minimum 300ms) {
  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <div class="h-8 bg-gray-200 rounded w-40 mb-2 animate-pulse"></div>
        <div class="h-4 bg-gray-200 rounded w-64 animate-pulse"></div>
      </div>
      <div class="space-y-6">
        @for (skeleton of skeletonArray; track $index) { 
          <app-order-skeleton></app-order-skeleton>
        }
      </div>
    </div>
  </div>
} @placeholder {
  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <div class="h-8 bg-gray-200 rounded w-40 mb-2"></div>
        <div class="h-4 bg-gray-200 rounded w-64"></div>
      </div>
    </div>
  </div>
} @error {
  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">Error al cargar órdenes</h3>
        <p class="mt-1 text-sm text-gray-500">Hubo un problema al cargar el historial de órdenes</p>
        <div class="mt-6">
          <button (click)="getOrders()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            Intentar Nuevamente
          </button>
        </div>
      </div>
    </div>
  </div>
}